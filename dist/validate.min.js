import _ from"lodash";import validators from"./validators.min.js";import{Deep}from"timeforce";var validate={validators:validators,validator:null,_validator(i=!1){var t=_.result(this,"validator");return t&&t[i?1:0]},deepValueSearch:Deep.search,validateAll:!0,_validate(i,t){if(!1===t.validate||!this.validate)return!0;var a=_.defaultsDeep(Deep.split(i),_.cloneDeep(this.attributes||{}));if(this.validationError=this.validate(a,t),!this.validationError&&t.validateForServer&&_.size(this.serverValidations||{})>0){var e=this.toJSON?this.toJSON({data:a}):a;this.validationError=this.validate(e,_.defaults({validations:this.serverValidations},t))}return!this.validationError||(this.trigger&&this.trigger("invalid",this,this.validationError,_.extend(t,{validationError:this.validationError})),!1)},validate(i,t={}){if(!this._validator())return null;var a=_.cloneDeep(i);t=_.defaults(t,{validateAll:this.validateAll});var e=[],r=this.getValidations(a,t),l=this.nonEmptyValidation(),o={};for(let i in r){o[i]=!0;let s,d=this.deepValueSearch(a,i);(!_.isArray(d)&&!_.isPlainObject(d)||!/\.\.\w+/.test(i)&&_.isArray(d))&&(d=[d]),!_.isArray(r[i])&&(r[i]=[r[i]]);for(let n in r[i]){let v=r[i][n];if(parseInt(n,10)||"string"!=typeof v){if(_.isArray(v)||(v=[v]),v[1]||(v[1]=s||this.getRequiredErrorMessage(i)),!0===v[2]&&(v[2]=(i,t,a)=>[i,t,a]),"boolean"==typeof v[0]||void 0===v[0]){if(o[i]=!1!==v,!o[i])continue;v=[l,v[1]||s||this.getRequiredErrorMessage(i),v[2]||null]}e=e.concat(this.validateValues(d,o[i],t.validateAll,i,a,v))}else s=v}}return e.length>0?e:null},nonEmptyValidation(){var i=this._validator(!0),t=this._validator();return i&&i.nonEmptyValidation(t)},validateValues(i,t,a,e,r,l){var o=[];for(var s in i)i[s]!==SyntaxError&&(o=o.concat(this.validateValue(s,i[s],t,a,e.replace("..",`.${s}.`),r,l)));return o},validateValue(i,t,a,e,r,l,o){var s=[];let d=this.getValidationValue(o,t,l,r);return this.isRequiredNow(d,a,e)&&!this.isValid(r,d,o[0],l)&&s.push([r,o[1],i]),s},getValidationValue:(i,t,a,e)=>i[2]&&"function"==typeof i[2]?i[2](t,a,e):t,getValidations(i,t={}){var a=("function"==typeof this.validations?this.validations(i,t):this.validations)||{};return("function"==typeof t.validations?_.bind(t.validations,this)(i,t):t.validations)||a},getMandatoryValidations(i,t={}){var a=this.getValidations(i,t),e={};for(let i in a){!_.isArray(a[i])&&(a[i]=[a[i]]);for(let t in a[i]){let r=a[i][t],l={test:""};(void 0===r[0]||"boolean"==typeof r[0]&&!1!==r[0]||"object"==typeof r[0]&&!this.isValid(i,"",r[0],l))&&(!(i in e)&&(e[i]=[]),e[i].push(r))}}return e},isRequiredNow:(i,t=!1,a)=>void 0!==i||!!t&&!!a,isValid(i,t,a,e){var r=this._validator(!0),l=this._validator();return r.isValid(l,a,t,i,e)},requiredErrorMessage:"Field *{{field}}* cannot be empty",getRequiredErrorMessage(i){return _.template(this.requiredErrorMessage)({field:i})},validatorDetection(i){var t=this._validator(!0);return t&&t.id===i}},mix=function(i,t){_.each(validate,(function(t,a){i.prototype[a]=t})),t&&(i.prototype.validator=t)};export{validate,mix};export default validate;